CC = g++
CFLAGS = -std=c++14 -Wall -Wextra -g -pthread -O0

# OpenSSL ç·¨è­¯å’Œéˆæ¥æ——æ¨™
OPENSSL_CFLAGS = $(shell pkg-config --cflags openssl 2>/dev/null || echo "")
OPENSSL_LIBS = $(shell pkg-config --libs openssl 2>/dev/null || echo "-lssl -lcrypto")

# æª¢æ¸¬ä½œæ¥­ç³»çµ±ä¸¦è¨­å®šé©ç•¶çš„ç·¨è­¯æ——æ¨™
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    # macOS ç‰¹å®šè¨­å®š
    CFLAGS += -D_DARWIN_C_SOURCE
    # macOS Homebrew OpenSSL è·¯å¾‘
    OPENSSL_PREFIX = $(shell brew --prefix openssl 2>/dev/null || echo "/usr/local/opt/openssl")
    OPENSSL_CFLAGS = -I$(OPENSSL_PREFIX)/include
    OPENSSL_LIBS = -L$(OPENSSL_PREFIX)/lib -lssl -lcrypto
else
    # Linux ç‰¹å®šè¨­å®š  
    CFLAGS += -D_GNU_SOURCE
endif

# åˆä½µæ‰€æœ‰æ——æ¨™
ALL_CFLAGS = $(CFLAGS) $(OPENSSL_CFLAGS)
ALL_LIBS = $(OPENSSL_LIBS)

# Phase 2 ç›®æ¨™æª”æ¡ˆ
SERVER_P2 = server_phase2
CLIENT_P2 = client_phase2

# Phase 1 ç›®æ¨™æª”æ¡ˆï¼ˆä¿æŒå‘ä¸‹ç›¸å®¹ï¼‰
SERVER_P1 = server
CLIENT_P1 = client

# æºæª”æ¡ˆ
SERVER_P2_SRC = Server_Phase2.cpp
CLIENT_P2_SRC = Client_Phase2.cpp
SERVER_P1_SRC = Server.cpp
CLIENT_P1_SRC = Client.cpp

# ä¾è³´æª”æ¡ˆ
THREADPOOL_HEADER = ThreadPool.h
P2P_HEADER = P2PClient.h
CRYPTO_HEADER = Crypto.h

# é è¨­ç›®æ¨™ï¼šç·¨è­¯Phase 2ç‰ˆæœ¬ï¼ˆå¸¶åŠ å¯†ï¼‰
all: phase2

# Phase 2ç‰ˆæœ¬ï¼ˆå¸¶åŠ å¯†ï¼‰
phase2: check-openssl $(SERVER_P2) $(CLIENT_P2)
	@echo "âœ… Phase 2 build completed (with OpenSSL encryption)"
	@echo "Server: ./$(SERVER_P2) [port]"
	@echo "Client: ./$(CLIENT_P2) [server_ip] [server_port]"

# Phase 1ç‰ˆæœ¬ï¼ˆå‚™ç”¨ï¼Œç„¡åŠ å¯†ï¼‰
phase1: $(SERVER_P1) $(CLIENT_P1)
	@echo "âœ… Phase 1 build completed"
	@echo "Server: ./$(SERVER_P1) [port]"
	@echo "Client: ./$(CLIENT_P1) [server_ip] [server_port]"

# ç·¨è­¯Phase 2 serverï¼ˆä¾è³´ThreadPool.hå’ŒCrypto.hï¼‰
$(SERVER_P2): $(SERVER_P2_SRC) $(THREADPOOL_HEADER) $(CRYPTO_HEADER)
	@echo "ğŸ”¨ Building Phase 2 Server with ThreadPool and OpenSSL..."
	$(CC) $(ALL_CFLAGS) -o $(SERVER_P2) $(SERVER_P2_SRC) $(ALL_LIBS)

# ç·¨è­¯Phase 2 clientï¼ˆä¾è³´P2PClient.hå’ŒCrypto.hï¼‰
$(CLIENT_P2): $(CLIENT_P2_SRC) $(P2P_HEADER) $(CRYPTO_HEADER)
	@echo "ğŸ”¨ Building Phase 2 Client with P2P and OpenSSL..."
	$(CC) $(ALL_CFLAGS) -o $(CLIENT_P2) $(CLIENT_P2_SRC) $(ALL_LIBS)

# ç·¨è­¯Phase 1 serverï¼ˆå‚™ç”¨ï¼Œç„¡åŠ å¯†ï¼‰
$(SERVER_P1): $(SERVER_P1_SRC)
	@echo "ğŸ”¨ Building Phase 1 Server (backup, no encryption)..."
	$(CC) $(CFLAGS) -o $(SERVER_P1) $(SERVER_P1_SRC)

# ç·¨è­¯Phase 1 clientï¼ˆå‚™ç”¨ï¼Œç„¡åŠ å¯†ï¼‰
$(CLIENT_P1): $(CLIENT_P1_SRC)
	@echo "ğŸ”¨ Building Phase 1 Client (backup, no encryption)..."
	$(CC) $(CFLAGS) -o $(CLIENT_P1) $(CLIENT_P1_SRC)

# æ¸…ç†æ‰€æœ‰ç·¨è­¯çµæœ
clean:
	@echo "ğŸ§¹ Cleaning up..."
	rm -f $(SERVER_P2) $(CLIENT_P2) $(SERVER_P1) $(CLIENT_P1)

# åªæ¸…ç†Phase 2
clean-p2:
	@echo "ğŸ§¹ Cleaning Phase 2..."
	rm -f $(SERVER_P2) $(CLIENT_P2)

# åªæ¸…ç†Phase 1
clean-p1:
	@echo "ğŸ§¹ Cleaning Phase 1..."
	rm -f $(SERVER_P1) $(CLIENT_P1)

# é‡æ–°ç·¨è­¯Phase 2
rebuild: clean phase2

# é‡æ–°ç·¨è­¯Phase 1
rebuild-p1: clean-p1 phase1

# åŸ·è¡ŒPhase 2 server
run-server-p2:
	@if [ ! -f $(SERVER_P2) ]; then echo "âŒ Phase 2 server not built. Run 'make phase2' first."; exit 1; fi
	./$(SERVER_P2) 8080

# åŸ·è¡ŒPhase 2 client
run-client-p2:
	@if [ ! -f $(CLIENT_P2) ]; then echo "âŒ Phase 2 client not built. Run 'make phase2' first."; exit 1; fi
	./$(CLIENT_P2) 127.0.0.1 8080

# åŸ·è¡ŒPhase 1 serverï¼ˆå‚™ç”¨ï¼‰
run-server-p1:
	@if [ ! -f $(SERVER_P1) ]; then echo "âŒ Phase 1 server not built. Run 'make phase1' first."; exit 1; fi
	./$(SERVER_P1) 8080

# åŸ·è¡ŒPhase 1 clientï¼ˆå‚™ç”¨ï¼‰
run-client-p1:
	@if [ ! -f $(CLIENT_P1) ]; then echo "âŒ Phase 1 client not built. Run 'make phase1' first."; exit 1; fi
	./$(CLIENT_P1) 127.0.0.1 8080

# æª¢æŸ¥OpenSSLæ˜¯å¦å®‰è£
check-openssl:
	@echo "ğŸ“‹ Checking OpenSSL installation..."
ifeq ($(UNAME_S),Darwin)
	@if ! brew list openssl >/dev/null 2>&1; then \
		echo "âŒ OpenSSL not found. Install with: brew install openssl"; \
		exit 1; \
	fi
	@echo "âœ… OpenSSL found at $(OPENSSL_PREFIX)"
else
	@if ! pkg-config --exists openssl 2>/dev/null; then \
		if [ ! -f /usr/include/openssl/evp.h ]; then \
			echo "âŒ OpenSSL not found. Install with: sudo apt-get install libssl-dev"; \
			exit 1; \
		fi; \
	fi
	@echo "âœ… OpenSSL found"
endif

# æª¢æŸ¥æ‰€æœ‰ä¾è³´
check-deps: check-openssl
	@echo "ğŸ“‹ Checking source dependencies..."
	@if [ ! -f $(THREADPOOL_HEADER) ]; then echo "âŒ Missing: $(THREADPOOL_HEADER)"; exit 1; fi
	@if [ ! -f $(P2P_HEADER) ]; then echo "âŒ Missing: $(P2P_HEADER)"; exit 1; fi
	@if [ ! -f $(CRYPTO_HEADER) ]; then echo "âŒ Missing: $(CRYPTO_HEADER)"; exit 1; fi
	@if [ ! -f $(SERVER_P2_SRC) ]; then echo "âŒ Missing: $(SERVER_P2_SRC)"; exit 1; fi
	@if [ ! -f $(CLIENT_P2_SRC) ]; then echo "âŒ Missing: $(CLIENT_P2_SRC)"; exit 1; fi
	@echo "âœ… All Phase 2 dependencies found"

# æ¸¬è©¦ç·¨è­¯
test-compile: check-deps
	@echo "ğŸ§ª Test compiling Phase 2 with OpenSSL..."
	$(CC) $(ALL_CFLAGS) -fsyntax-only $(SERVER_P2_SRC)
	$(CC) $(ALL_CFLAGS) -fsyntax-only $(CLIENT_P2_SRC)
	@echo "âœ… Syntax check passed"

# æ¸¬è©¦åŠ å¯†åŠŸèƒ½
test-crypto: $(SERVER_P2) $(CLIENT_P2)
	@echo "ğŸ§ª Running encryption test..."
	@echo "Start server in another terminal: ./$(SERVER_P2) 8080"
	@echo "Then run client: ./$(CLIENT_P2) 127.0.0.1 8080"
	@echo "Encryption self-test runs automatically on startup"

# é¡¯ç¤ºå¹«åŠ©
help:
	@echo "=== Phase 2 Socket Programming Makefile (with OpenSSL) ==="
	@echo ""
	@echo "Main targets:"
	@echo "  phase2      - Build Phase 2 with encryption (default)"
	@echo "  phase1      - Build Phase 1 without encryption (backup)"
	@echo "  clean       - Clean all build files"
	@echo "  rebuild     - Clean and rebuild Phase 2"
	@echo ""
	@echo "Running:"
	@echo "  run-server-p2  - Run Phase 2 server (port 8080)"
	@echo "  run-client-p2  - Run Phase 2 client"
	@echo "  run-server-p1  - Run Phase 1 server"
	@echo "  run-client-p1  - Run Phase 1 client"
	@echo ""
	@echo "Development:"
	@echo "  check-openssl  - Check OpenSSL installation"
	@echo "  check-deps     - Check if all files exist"
	@echo "  test-compile   - Test syntax without building"
	@echo "  test-crypto    - Instructions for encryption test"
	@echo ""
	@echo "Features in Phase 2:"
	@echo "  âœ… Professional ThreadPool (10 workers)"
	@echo "  âœ… P2P Direct Messaging"
	@echo "  âœ… OpenSSL Encryption (AES-256-CBC)"
	@echo "     - Client-Server encrypted communication"
	@echo "     - P2P encrypted messaging"
	@echo "  âœ… Detailed logging and monitoring"
	@echo ""
	@echo "OpenSSL Installation:"
	@echo "  macOS:  brew install openssl"
	@echo "  Ubuntu: sudo apt-get install libssl-dev"
	@echo "  CentOS: sudo yum install openssl-devel"

# é¡¯ç¤ºç·¨è­¯æ——æ¨™ï¼ˆé™¤éŒ¯ç”¨ï¼‰
show-flags:
	@echo "CFLAGS: $(CFLAGS)"
	@echo "OPENSSL_CFLAGS: $(OPENSSL_CFLAGS)"
	@echo "OPENSSL_LIBS: $(OPENSSL_LIBS)"
	@echo "ALL_CFLAGS: $(ALL_CFLAGS)"
	@echo "ALL_LIBS: $(ALL_LIBS)"

.PHONY: all phase1 phase2 clean clean-p1 clean-p2 rebuild rebuild-p1 \
        run-server-p2 run-client-p2 run-server-p1 run-client-p1 \
        check-openssl check-deps test-compile test-crypto help show-flags