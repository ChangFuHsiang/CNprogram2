CC = g++
CFLAGS = -std=c++14 -Wall -Wextra -g -pthread -O0

# OpenSSL
OPENSSL_LIBS = -lssl -lcrypto

# ä½œæ¥­ç³»çµ±æª¢æ¸¬
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    CFLAGS += -D_DARWIN_C_SOURCE
    OPENSSL_PREFIX = $(shell brew --prefix openssl 2>/dev/null || echo "/usr/local/opt/openssl")
    OPENSSL_CFLAGS = -I$(OPENSSL_PREFIX)/include
    OPENSSL_LIBS = -L$(OPENSSL_PREFIX)/lib -lssl -lcrypto
else
    CFLAGS += -D_GNU_SOURCE
    OPENSSL_CFLAGS =
endif

ALL_CFLAGS = $(CFLAGS) $(OPENSSL_CFLAGS)
ALL_LIBS = $(OPENSSL_LIBS)

# ç›®æ¨™æª”æ¡ˆ
SERVER = server_phase2
CLIENT = client_phase2

# æºæª”æ¡ˆ
SERVER_SRC = Server_Phase2.cpp
CLIENT_SRC = Client_Phase2.cpp

# æ¨™é ­æª”
HEADERS = ThreadPool.h Crypto.h P2PClient.h FileTransfer.h

# é è¨­ç›®æ¨™
all: $(SERVER) $(CLIENT)
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘     Build Complete - Phase 2 Full        â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘ Features:                                â•‘"
	@echo "â•‘  âœ… ThreadPool (10 workers)              â•‘"
	@echo "â•‘  âœ… P2P Direct Messaging                 â•‘"
	@echo "â•‘  âœ… OpenSSL Encryption (AES-256-CBC)     â•‘"
	@echo "â•‘  âœ… Group Chat (Relay Mode)              â•‘"
	@echo "â•‘  âœ… File Transfer (Encrypted)            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Usage:"
	@echo "  ./$(SERVER) [port]              - Start server"
	@echo "  ./$(CLIENT) [ip] [port]         - Start client"

$(SERVER): $(SERVER_SRC) $(HEADERS)
	@echo "ğŸ”¨ Building Server..."
	$(CC) $(ALL_CFLAGS) -o $(SERVER) $(SERVER_SRC) $(ALL_LIBS)
	@echo "âœ… Server built"

$(CLIENT): $(CLIENT_SRC) $(HEADERS)
	@echo "ğŸ”¨ Building Client..."
	$(CC) $(ALL_CFLAGS) -o $(CLIENT) $(CLIENT_SRC) $(ALL_LIBS)
	@echo "âœ… Client built"

clean:
	@echo "ğŸ§¹ Cleaning..."
	rm -f $(SERVER) $(CLIENT)
	@echo "âœ… Clean complete"

rebuild: clean all

# æª¢æŸ¥ OpenSSL
check-openssl:
	@echo "ğŸ“‹ Checking OpenSSL..."
ifeq ($(UNAME_S),Darwin)
	@brew list openssl >/dev/null 2>&1 || (echo "âŒ Install: brew install openssl" && exit 1)
else
	@(pkg-config --exists openssl 2>/dev/null || [ -f /usr/include/openssl/evp.h ]) || \
		(echo "âŒ Install: sudo apt-get install libssl-dev" && exit 1)
endif
	@echo "âœ… OpenSSL found"

# æª¢æŸ¥æ‰€æœ‰æª”æ¡ˆ
check-deps: check-openssl
	@echo "ğŸ“‹ Checking files..."
	@for f in $(HEADERS) $(SERVER_SRC) $(CLIENT_SRC); do \
		[ -f "$$f" ] || (echo "âŒ Missing: $$f" && exit 1); \
	done
	@echo "âœ… All files present"

# åŸ·è¡Œ
run-server: $(SERVER)
	./$(SERVER) 8080

run-client: $(CLIENT)
	./$(CLIENT) 127.0.0.1 8080

# æ¸¬è©¦
test: $(SERVER) $(CLIENT)
	@echo "ğŸ§ª Ready for testing"
	@echo "1. Start server:  ./$(SERVER) 8080"
	@echo "2. Start client:  ./$(CLIENT) 127.0.0.1 8080"

# å¹«åŠ©
help:
	@echo "=== Phase 2 Complete Makefile ==="
	@echo ""
	@echo "Targets:"
	@echo "  all          - Build everything (default)"
	@echo "  clean        - Remove binaries"
	@echo "  rebuild      - Clean and rebuild"
	@echo "  check-deps   - Check dependencies"
	@echo "  run-server   - Run server on port 8080"
	@echo "  run-client   - Run client"
	@echo "  test         - Show test instructions"
	@echo "  help         - Show this help"
	@echo ""
	@echo "OpenSSL Installation:"
	@echo "  macOS:  brew install openssl"
	@echo "  Ubuntu: sudo apt-get install libssl-dev"

.PHONY: all clean rebuild check-openssl check-deps run-server run-client test help
