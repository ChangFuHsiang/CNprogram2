# (åŸºæ–¼åŸå§‹æª”æ¡ˆä¿®æ”¹)
CC = g++
CFLAGS = -std=c++14 -Wall -Wextra -g -pthread -O0

# OpenSSL
OPENSSL_LIBS = -lssl -lcrypto

# ä½œæ¥­ç³»çµ±æª¢æ¸¬
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    CFLAGS += -D_DARWIN_C_SOURCE
    OPENSSL_PREFIX = $(shell brew --prefix openssl 2>/dev/null || echo "/usr/local/opt/openssl")
    OPENSSL_CFLAGS = -I$(OPENSSL_PREFIX)/include
    OPENSSL_LIBS = -L$(OPENSSL_PREFIX)/lib -lssl -lcrypto
else
    CFLAGS += -D_GNU_SOURCE
    OPENSSL_CFLAGS =
endif

ALL_CFLAGS = $(CFLAGS) $(OPENSSL_CFLAGS)
ALL_LIBS = $(OPENSSL_LIBS)

# ç›®æ¨™æª”æ¡ˆ
SERVER = server_phase2
CLIENT = client_phase2

# æºæª”æ¡ˆ
SERVER_SRC = Server_Phase2.cpp
CLIENT_SRC = Client_Phase2.cpp

# æ¨™é ­æª”
HEADERS = ThreadPool.h Crypto.h P2PClient.h FileTransfer.h

# é è¨­ç›®æ¨™
all: $(SERVER) $(CLIENT)
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘     Build Complete - Phase 2 Full        â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘ Features:                                â•‘"
	@echo "â•‘  âœ… ThreadPool (10 workers)              â•‘"
	@echo "â•‘  âœ… P2P Direct Messaging                 â•‘"
	@echo "â•‘  âœ… OpenSSL Encryption (AES-256-CBC)     â•‘"
	@echo "â•‘  âœ… Group Chat (Relay Mode)              â•‘"
	@echo "â•‘  âœ… File Transfer (Encrypted)            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸš€ Quick Start:"
	@echo "  1. make setup           - Create Alice/Bob test env"
	@echo "  2. make run-server      - Start server"
	@echo "  3. make run-alice       - Start client Alice (Sender)"
	@echo "  4. make run-bob         - Start client Bob (Receiver)"

$(SERVER): $(SERVER_SRC) $(HEADERS)
	@echo "ğŸ”¨ Building Server..."
	$(CC) $(ALL_CFLAGS) -o $(SERVER) $(SERVER_SRC) $(ALL_LIBS)
	@echo "âœ… Server built"

$(CLIENT): $(CLIENT_SRC) $(HEADERS)
	@echo "ğŸ”¨ Building Client..."
	$(CC) $(ALL_CFLAGS) -o $(CLIENT) $(CLIENT_SRC) $(ALL_LIBS)
	@echo "âœ… Client built"

clean:
	@echo "ğŸ§¹ Cleaning binaries..."
	rm -f $(SERVER) $(CLIENT)
	@echo "âœ… Clean complete"

# === âœ¨ æ–°å¢ï¼šè‡ªå‹•åŒ–æ¸¬è©¦ç’°å¢ƒè¨­ç½® ===

# å»ºç«‹ç¨ç«‹çš„æ¸¬è©¦è³‡æ–™å¤¾ï¼Œé˜²æ­¢æª”æ¡ˆè¦†è“‹
setup: all
	@echo "ğŸ“¦ Setting up test environment..."
	@mkdir -p alice_dir
	@mkdir -p bob_dir
	@cp $(CLIENT) alice_dir/
	@cp $(CLIENT) bob_dir/
	@echo "Hello World from Alice!" > alice_dir/test.txt
	@echo "âœ… Environment ready:"
	@echo "   ğŸ“‚ alice_dir/ (contains test.txt)"
	@echo "   ğŸ“‚ bob_dir/"

# æ¸…é™¤æ¸¬è©¦ç’°å¢ƒ
clean-env: clean
	@echo "ğŸ§¹ Cleaning test environment..."
	rm -rf alice_dir bob_dir
	@echo "âœ… Test environment removed"

rebuild: clean-env all

# æª¢æŸ¥ä¾è³´
check-deps:
	@echo "ğŸ“‹ Checking OpenSSL..."
ifeq ($(UNAME_S),Darwin)
	@brew list openssl >/dev/null 2>&1 || (echo "âŒ Install: brew install openssl" && exit 1)
else
	@(pkg-config --exists openssl 2>/dev/null || [ -f /usr/include/openssl/evp.h ]) || \
		(echo "âŒ Install: sudo apt-get install libssl-dev" && exit 1)
endif
	@echo "âœ… OpenSSL found"
	@echo "ğŸ“‹ Checking files..."
	@for f in $(HEADERS) $(SERVER_SRC) $(CLIENT_SRC); do \
		[ -f "$$f" ] || (echo "âŒ Missing: $$f" && exit 1); \
	done
	@echo "âœ… All files present"

# === ğŸš€ åŸ·è¡ŒæŒ‡ä»¤ (ä¿®æ”¹ç‰ˆ) ===

run-server: $(SERVER)
	@echo "ğŸŸ¢ Starting Server on port 8080..."
	./$(SERVER) 8080

# åœ¨ alice_dir ä¸­åŸ·è¡Œ Client
run-alice:
	@if [ ! -d "alice_dir" ]; then echo "âš ï¸ Please run 'make setup' first"; exit 1; fi
	@echo "ğŸ‘¤ Starting Alice..."
	@cd alice_dir && ./$(CLIENT) 127.0.0.1 8080

# åœ¨ bob_dir ä¸­åŸ·è¡Œ Client
run-bob:
	@if [ ! -d "bob_dir" ]; then echo "âš ï¸ Please run 'make setup' first"; exit 1; fi
	@echo "ğŸ‘¤ Starting Bob..."
	@cd bob_dir && ./$(CLIENT) 127.0.0.1 8080

.PHONY: all clean rebuild check-deps run-server run-alice run-bob setup clean-env